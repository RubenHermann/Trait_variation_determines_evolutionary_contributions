---
title: "Testing with paired models"
author: "Ruben Hermann"
date: '2022-06-29'
output: html_document
---

In this script I am using the feature values of the treatments and the trained keras model to predict the frequency of each clone at each day (sampling time point) and save the predicted frequencies

```{r setup}
rm(list=ls())

knitr::opts_chunk$set(echo = TRUE)
library(keras)
library(tidyverse)
```

## The function
In the "freq_1v1" function all the frequencies get tested of a certain paring of clones. The feature values need to be scaled according the training data, therefore that data will be loaded in as well. It reads in the name of the defended clone (cloneA) "CR1" or "CR2" and the undefended clone (cloneB) "CR6" or "CR7" and takes the appropriate data from the "Keras model training" folder.

```{r}
freq_1v1 <- function(cloneA,cloneB){
  
  nmodel <- paste("../../Data/Keras Models/Distinguish ",cloneA,"v",cloneB," clones with feature values.h5",sep="")  
    
  model <- load_model_hdf5(nmodel)
  
  dcloneA <- paste('../../Data/ISX/Keras model training/',cloneA,'_train.csv',sep="")
  cloneA_train <- read.csv(dcloneA)
  if(cloneA=="CR1"){
   dcloneB <- paste('../../Data/ISX/Keras model training/',cloneB,'_train_long.csv',sep="")}
    if(cloneA=="CR2"){
   dcloneB <- paste('../../Data/ISX/Keras model training/',cloneB,'_train_short.csv',sep="")}
  
  cloneB_train <- read.csv(dcloneB)
  train_all <- rbind(cloneA_train,cloneB_train)
  train_all <- select(train_all,-X)
  mean <- apply(train_all,2,mean)
  std <- apply(train_all,2,sd)

  setwd('../../Data/ISX/Renamed feature files/Treatment')
  pat <- paste("_",cloneA,"_",cloneB,"_",sep="")
  temp= list.files(pattern=pat)
  listofdf<-list()
  for (i in 1:length(temp)) {
    listofdf[[i]]=read.csv(temp[i])}
  names(listofdf) <- temp
  setwd("../../../../Scripts/processing")

  freq_dat_all=NULL

   
  for (j in 1:length(listofdf)) {
    df <- listofdf[[j]]
    df <- select(df,-X)
    
    df_sc <- scale(df,center=mean,scale=std)
    df_sc <- as.data.frame(df_sc)

  
    #Now getting rid of the unecessary features
    list=names(df_sc)
    #list <- list[list != 'ID'] # remove 'ID' which tells identity of the isolates
    list <- list[list != 'Object.Number'] # removing the object number it is not needed
    list <- list[!str_detect(list, 'Saturation')] #remove Saturation Perc as it always is 0
    list <- list[!str_detect(list, 'Bkgd')] #remove Background information
    #apply the list back to the data frame
    df_sc <- df_sc %>% dplyr::select(all_of(list))
  
    #First getting rid of the ID column
    no_vars=length(list)
    test_x <- df_sc[,1:no_vars] %>% as.matrix
    

    predict <- model %>% predict(test_x)
  
    pred<-data.frame(pred_ID=rep(0,nrow(predict)))

    #Comparing the predicted data with the real data
    for (i in 1:nrow(predict)){
      #Which clone is predicted by the model
      pred$pred_ID[i]=which.max(predict[i,])
      #Categorizing the clones into defended and undefended (clones 1 as defended and 4 as undefended)
    }
    sname <- strsplit(names(listofdf)[j],split="_")
    sday <- strsplit(sname[[1]][6],split="y")
    sfreq <- strsplit(sname[[1]][5],split="f")
    freq_dat <- data.frame(pred_cloneA_freq=length(pred$pred_ID[pred$pred_ID==1])/length(pred$pred_ID),
                           pred_cloneB_freq=length(pred$pred_ID[pred$pred_ID==2])/length(pred$pred_ID),
                           clone_A=cloneA,clone_B=cloneB,filename=temp[j],ID=as.numeric(sname[[1]][1]),
                           freq_def=as.numeric(sfreq[[1]][2]),day=as.numeric(sday[[1]][2]),run=sname[[1]][7])
    
    freq_dat_all <- rbind(freq_dat_all,freq_dat)
  
  }
  return(freq_dat_all)
}
  
```

Running the functions for all clonal combinations for each Keras model and saving all data together in one folder.

```{r}
CR2_CR6_freq <- freq_1v1("CR2","CR6")
CR2_CR7_freq <- freq_1v1("CR2","CR7")
CR1_CR6_freq <- freq_1v1("CR1","CR6")
CR1_CR7_freq <- freq_1v1("CR1","CR7")

all_freq <- bind_rows(CR2_CR6_freq,CR2_CR7_freq,CR1_CR6_freq,CR1_CR7_freq)

write.csv(all_freq,"../../Data/ISX/Predicted frequencies paired model.csv")
```